From 2b263c0fb24027b2b7877ffa4cb4de3709c43942 Mon Sep 17 00:00:00 2001
From: Alexandre Rostovtsev <tetromino@gmail.com>
Date: Wed, 7 Sep 2011 17:17:42 -0400
Subject: [PATCH] Make networkmanager optional

Some people cannot use it for various reasons (e.g. prefix).
---
 src/ephy-shell.c |   14 ++++++++++++++
 1 files changed, 14 insertions(+), 0 deletions(-)

diff --git a/src/ephy-shell.c b/src/ephy-shell.c
index f5759d4..83a9e0e 100644
--- a/src/ephy-shell.c
+++ b/src/ephy-shell.c
@@ -70,7 +70,9 @@ struct _EphyShellPrivate {
   EggToolbarsModel *toolbars_model;
   EggToolbarsModel *fs_toolbars_model;
   EphyExtensionsManager *extensions_manager;
+#ifdef ENABLE_NETWORK_MANAGER
   EphyNetworkManager *nm_proxy;
+#endif
   GtkWidget *bme;
   GtkWidget *history_window;
   GObject *pdm_dialog;
@@ -439,6 +441,8 @@ ephy_shell_new_window_cb (EphyEmbedSingle *single,
      NULL, NULL, flags, chromemask, is_popup, 0);
 }
 
+#ifdef ENABLE_NETWORK_MANAGER
+
 static void
 ephy_shell_sync_network_status (EphyNetworkManager *nm_proxy,
                                 NMState state,
@@ -456,6 +460,8 @@ ephy_shell_sync_network_status (EphyNetworkManager *nm_proxy,
   ephy_embed_single_set_network_status (single, net_status);
 }
 
+#endif /* ENABLE_NETWORK_MANAGER */
+
 static GObject*
 impl_get_embed_single (EphyEmbedShell *embed_shell)
 {
@@ -473,11 +479,13 @@ impl_get_embed_single (EphyEmbedShell *embed_shell)
 
     priv->embed_single_connected = TRUE;
 
+#ifdef ENABLE_NETWORK_MANAGER
     /* Now we need the net monitor   */
     ephy_shell_get_net_monitor (shell);
     ephy_shell_sync_network_status (priv->nm_proxy,
                                     ephy_network_manager_get_state (priv->nm_proxy),
                                     shell);
+#endif
   }
 
   return embed_single;
@@ -566,6 +574,7 @@ ephy_shell_dispose (GObject *object)
     priv->bookmarks = NULL;
   }
 
+#ifdef ENABLE_NETWORK_MANAGER
   if (priv->nm_proxy != NULL) {
     LOG ("Unref net monitor ");
     g_signal_handlers_disconnect_by_func
@@ -573,6 +582,7 @@ ephy_shell_dispose (GObject *object)
     g_object_unref (priv->nm_proxy);
     priv->nm_proxy = NULL;
   }
+#endif /* ENABLE_NETWORK_MANAGER */
 
   G_OBJECT_CLASS (ephy_shell_parent_class)->dispose (object);
 }
@@ -918,6 +928,7 @@ ephy_shell_get_extensions_manager (EphyShell *es)
 GObject *
 ephy_shell_get_net_monitor (EphyShell *shell)
 {
+#ifdef ENABLE_NETWORK_MANAGER
   EphyShellPrivate *priv = shell->priv;
 
   if (priv->nm_proxy == NULL) {
@@ -932,6 +943,9 @@ ephy_shell_get_net_monitor (EphyShell *shell)
   }
 
   return G_OBJECT (priv->nm_proxy);
+#else
+  return NULL;
+#endif /* ENABLE_NETWORK_MANAGER */
 }
 
 static void
-- 
1.7.6.1

