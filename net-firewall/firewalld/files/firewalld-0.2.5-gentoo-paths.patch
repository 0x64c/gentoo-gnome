From a7afb4b69ab10ebe39ec243f9a6b453e1dbe952c Mon Sep 17 00:00:00 2001
From: Alexandre Rostovtsev <tetromino@gentoo.org>
Date: Wed, 18 Jul 2012 17:52:01 -0400
Subject: [PATCH] Fix Gentoo paths

Also, make applet installation optional.
---
 config/Makefile.am       |   19 +++++++++++++------
 config/firewalld.service |    2 +-
 configure.in             |    5 +++++
 src/Makefile.am          |   14 +++++++++++---
 4 files changed, 30 insertions(+), 10 deletions(-)

diff --git a/config/Makefile.am b/config/Makefile.am
index 564242d..823e080 100644
--- a/config/Makefile.am
+++ b/config/Makefile.am
@@ -1,11 +1,13 @@
 sconfdir = $(sysconfdir)/firewalld
-prefixlibdir = ${prefix}/lib/firewalld
+prefixlibdir = $(libdir)/firewalld
 dist_sconf_DATA = firewalld.conf
 
+if WANT_APPLET
 desktop_FILES = firewall-applet.desktop.in
 #firewall-config.desktop.in
 desktopdir = $(datadir)/applications
 dist_desktop_DATA = $(desktop_FILES:.in=)
+endif
 
 polkit1_action_FILES = org.fedoraproject.FirewallD1.policy.in
 polkit1_actiondir = $(datadir)/polkit-1/actions
@@ -14,8 +16,10 @@ dist_polkit1_action_DATA = $(polkit1_action_FILES:.in=)
 dbus_policydir = $(sysconfdir)/dbus-1/system.d
 dist_dbus_policy_DATA = FirewallD.conf
 
+if WANT_APPLET
 gsettings_in_file = org.fedoraproject.FirewallApplet.gschema.xml.in
 gsettings_SCHEMAS = $(gsettings_in_file:.xml.in=.xml)
+endif
 
 @INTLTOOL_DESKTOP_RULE@
 @INTLTOOL_POLICY_RULE@
@@ -76,14 +80,17 @@ uninstall-service:
 	rm -f $(DESTDIR)$(SYSTEMD_UNITDIR)/firewalld.service
 
 install-config:
-	mkdir -p $(DESTDIR)$(sconfdir)
-	mkdir -p $(DESTDIR)$(sconfdir)/icmptypes
-	mkdir -p $(DESTDIR)$(sconfdir)/services
-	mkdir -p $(DESTDIR)$(sconfdir)/zones
-	mkdir -p $(DESTDIR)$(prefixlibdir)
+	mkdir -m 0750 -p $(DESTDIR)$(sconfdir)
+	mkdir -m 0750 -p $(DESTDIR)$(sconfdir)/icmptypes
+	mkdir -m 0750 -p $(DESTDIR)$(sconfdir)/services
+	mkdir -m 0750 -p $(DESTDIR)$(sconfdir)/zones
+	mkdir -m 0750 -p $(DESTDIR)$(prefixlibdir)
 	cp -r icmptypes $(DESTDIR)$(prefixlibdir)
+	chmod 0750 $(DESTDIR)$(prefixlibdir)/icmptypes
 	cp -r services $(DESTDIR)$(prefixlibdir)
+	chmod 0750 $(DESTDIR)$(prefixlibdir)/services
 	cp -r zones $(DESTDIR)$(prefixlibdir)
+	chmod 0750 $(DESTDIR)$(prefixlibdir)/zones
 
 uninstall-config:
 	rmdir $(DESTDIR)$(sconfdir)/icmptypes
diff --git a/config/firewalld.service b/config/firewalld.service
index 7280a4c..0b44b2f 100644
--- a/config/firewalld.service
+++ b/config/firewalld.service
@@ -8,7 +8,7 @@ Before=NetworkManager.service
 Conflicts=iptables.service ip6tables.service ebtables.service
 
 [Service]
-EnvironmentFile=-/etc/sysconfig/firewalld
+EnvironmentFile=-/etc/conf.d/firewalld
 ExecStart=/usr/sbin/firewalld --nofork $FIREWALLD_ARGS
 ExecReload=/bin/kill -HUP $MAINPID
 # supress to log debug and error output also to /var/log/messages
diff --git a/configure.in b/configure.in
index 2acb0bc..5121cf8 100644
--- a/configure.in
+++ b/configure.in
@@ -39,6 +39,11 @@ AC_ARG_WITH([systemd-unitdir],
        [SYSTEMD_UNITDIR=$withval], [SYSTEMD_UNITDIR="/lib/systemd/system"])
 AC_SUBST(SYSTEMD_UNITDIR)
 
+AC_ARG_ENABLE([applet],
+        AS_HELP_STRING([--disable-applet], [Do not install GTK applet]),
+        [want_applet=$enableval], [want_applet=yes])
+AM_CONDITIONAL(WANT_APPLET, test x$want_applet != xno)
+
 #############################################################
 
 AC_SUBST([GETTEXT_PACKAGE], '[PKG_NAME]')
diff --git a/src/Makefile.am b/src/Makefile.am
index d778c33..5c13e7f 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -1,17 +1,23 @@
-bin_SCRIPTS = firewall-applet firewall-cmd
+bin_SCRIPTS = firewall-cmd
 #firewall-config
 sbin_SCRIPTS = firewalld
 
+if WANT_APPLET
+bin_SCRIPTS += firewall-applet
 icondir = $(datadir)/icons/hicolor
 iconFILES = icons/*/apps/*
+endif
 
 EXTRA_DIST = $(bin_SCRIPTS) \
 	$(sbin_SCRIPTS) \
 	firewall/*.py \
 	firewall/*/*.py \
 	firewall/*/*.py.in \
-	firewall/*/*/*.py \
-	$(iconFILES)
+	firewall/*/*/*.py
+
+if WANT_APPLET
+EXTRA_DIST += $(iconFILES)
+endif
 
 CLEANFILES = *~ *\# .\#* *.py?
 
@@ -20,5 +26,7 @@ install-data-local:
 	cp -fpR firewall $(DESTDIR)/$(pythondir)
 	find $(DESTDIR)/$(pythondir) -name "*.in" -exec rm {} \;
 
+if WANT_APPLET
 	install -d $(DESTDIR)/$(icondir)
 	cp -fpR icons/* $(DESTDIR)/$(icondir)
+endif
-- 
1.7.8.6

